{% extends "panel/base.html" %}

{% block title %}Producción de Huevos{% endblock %}

{% block content %}

<h1 class="page-title mb-4">Producción de Huevos</h1>

<div class="row">
    <div class="col-md-4">
        <div class="card p-4 shadow-sm">
            <h5>Agregar Producción</h5>
            {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
            {% endif %}
            <form method="POST">
                {% csrf_token %}
                <div class="mb-3">
                    <label class="form-label">Fecha</label>
                    <p class="form-control-plaintext">{{ today|date:"d/m/Y" }} (automática)</p>
                    <input type="hidden" name="fecha" value="{{ today }}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Tipo de Huevo</label>
                    <select name="tipo_huevo" class="form-control">
                        <option value="PEQUEÑO">Pequeño</option>
                        <option value="MEDIANO" selected>Mediano</option>
                        <option value="GRANDE">Grande</option>
                        <option value="EXTRA_GRANDE">Extra Grande</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Cantidad</label>
                    <input type="number" name="cantidad" class="form-control" min="1" required>
                </div>
                <button class="btn btn-success">Agregar</button>
            </form>
        </div>
    </div>
    <div class="col-md-8">
        <div class="card p-4 shadow-sm text-center">
            <h5 class="mb-3">Producción de Huevos por Fecha</h5>
            <canvas id="produccionChart" style="max-height:300px;"></canvas>
        </div>
    </div>
</div>

<!-- LISTA DE PRODUCCIONES -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card p-4 shadow-sm">
            <h5>Lista de Producciones</h5>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Cantidad</th>
                        <th>Tipo de Huevo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for prod in producciones %}
                    <tr>
                        <td>{{ prod.fecha }}</td>
                        <td>{{ prod.cantidad }}</td>
                        <td>{{ prod.get_tipo_huevo_display }}</td>
                        <td>
                            <a href="{% url 'produccion_huevos_editar' prod.id %}" class="btn btn-sm btn-warning">Editar</a>
                            <a href="{% url 'produccion_huevos_eliminar' prod.id %}" class="btn btn-sm btn-danger" onclick="return confirm('¿Eliminar esta producción?')">Eliminar</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center">No hay producciones registradas.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- SCRIPT PARA EL GRÁFICO -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const fechas = {{ fechas_json|default:'[]'|safe }};
const tipos = {{ tipos_json|default:'{}'|safe }};
let chart = null;

function renderChart(){
    const ctx = document.getElementById('produccionChart');
    if(chart) chart.destroy();
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: fechas,
            datasets: [{
                label: 'Pequeño',
                data: tipos.PEQUEÑO || [],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                fill: false
            }, {
                label: 'Mediano',
                data: tipos.MEDIANO || [],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                fill: false
            }, {
                label: 'Grande',
                data: tipos.GRANDE || [],
                borderColor: '#fd7e14',
                backgroundColor: 'rgba(253, 126, 20, 0.1)',
                fill: false
            }, {
                label: 'Extra Grande',
                data: tipos.EXTRA_GRANDE || [],
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                fill: false
            }]
        },
        options: { 
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// Dibujar gráfico inicial si hay datos
if(fechas.length > 0){
    renderChart();
}
</script>

{% endblock %}