{% extends "panel/base.html" %}

{% block title %}Inicio - EcoRaciÃ³n{% endblock %}

{% block content %}

<div class="row g-3 mb-3">

    <div class="col-md-4">
        <div class="metric-card">
            <h6>Total insumos</h6>
            <span>{{ insumos|length }}</span>
        </div>
    </div>

    <div class="col-md-4">
        <div class="metric-card metric-card-secondary">
            <h6>Alertas activas</h6>
            <span>{{ alertas_stock|length }}</span>
        </div>
    </div>

    <div class="col-md-4">
        <div class="alerta-stock-card">
            <h6 class="mb-2">ðŸ“¦ Stock Actual</h6>

            {% if alertas_stock and alertas_stock|length > 0 %}
                {% for a in alertas_stock|slice:":3" %}
                    <div class="alerta-item">
                        <div class="alerta-label">
                            {% if a.nivel == 'CRITICO' or a.nivel == 'CrÃ­tico' %}
                                <div class="alerta-icon-danger"></div>
                            {% else %}
                                <div class="alerta-icon-warning"></div>
                            {% endif %}
                            <span>{{ a.nombre }}: {{ a.stock_actual }}</span>
                        </div>
                        <small>{{ a.nivel }}</small>
                    </div>
                {% endfor %}
                <div class="mt-2">
                    <a href="{% url 'stock' %}" class="small">Ver todos â†’</a>
                </div>
            {% else %}
                <p class="text-muted mb-0 small">Todos los insumos estÃ¡n en niveles normales.</p>
                <div class="mt-2">
                    <a href="{% url 'stock' %}" class="small">Ir a Stock â†’</a>
                </div>
            {% endif %}

        </div>
    </div>
</div>

<!-- GRÃFICO DE PRODUCCIÃ“N DE HUEVOS -->
<div class="row g-3 mt-3">
    <div class="col-12">
        <div class="card p-3">
            <h6 class="mb-3">ProducciÃ³n de Huevos por Tipo</h6>
            <canvas id="produccionChart" style="max-height:300px;"></canvas>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('mainChart');

    const dataConsumo = {{ datos_consumo|default:"[120,130,118]"|safe }};
    const dataAhorro = {{ datos_ahorro|default:"[8,12,15]"|safe }};

    if (ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Ago', 'Sep', 'Oct'],
                datasets: [
                    {
                        label: 'Consumo (kg)',
                        data: dataConsumo,
                        tension: 0.3
                    },
                    {
                        label: 'Ahorro (%)',
                        data: dataAhorro,
                        tension: 0.3
                    }
                ]
            }
        });
    }

    // GrÃ¡fico de producciÃ³n de huevos
    const fechas = {{ fechas_json|default:'[]'|safe }};
    const tipos = {{ tipos_json|default:'{}'|safe }};
    let chart = null;

    function renderChart(){
        const ctxProd = document.getElementById('produccionChart');
        if(chart) chart.destroy();
        chart = new Chart(ctxProd, {
            type: 'line',
            data: {
                labels: fechas,
                datasets: [{
                    label: 'PequeÃ±o',
                    data: tipos.PEQUEÃ‘O || [],
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    fill: false
                }, {
                    label: 'Mediano',
                    data: tipos.MEDIANO || [],
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    fill: false
                }, {
                    label: 'Grande',
                    data: tipos.GRANDE || [],
                    borderColor: '#fd7e14',
                    backgroundColor: 'rgba(253, 126, 20, 0.1)',
                    fill: false
                }, {
                    label: 'Extra Grande',
                    data: tipos.EXTRA_GRANDE || [],
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    fill: false
                }]
            },
            options: { 
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    // Dibujar grÃ¡fico inicial si hay datos
    if(fechas.length > 0){
        renderChart();
    }
</script>
{% endblock %}
