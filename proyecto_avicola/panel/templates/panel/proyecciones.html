{% extends "panel/base.html" %}

{% block title %}Proyecciones - EcoRación{% endblock %}

{% block content %}

<h1 class="page-title mb-4">Proyección de Insumos</h1>

<div class="row g-4">

    <!-- FORMULARIO -->
    <div class="col-lg-7">

        <div class="card shadow-sm p-4 mb-3">
            <form id="form-proyecciones">

                <!-- SELECCIONAR RACIÓN PREVIA -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Ración base para la proyección</label>
                    <select class="form-select" name="racion_id" required>
                        <option value="">Seleccione una ración guardada...</option>
                        {% for r in raciones %}
                            <option value="{{ r.id }}">{{ r.descripcion }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- UNIDAD DE DATOS DE LA RACIÓN -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Unidad de los valores de la ración</label>
                    <select class="form-select" name="unidad_racion" id="unidad_racion">
                        <option value="g">Gramos (g)</option>
                        <option value="kg">Kilogramos (kg)</option>
                    </select>
                    <small class="text-muted">Selecciona si los valores de 'granos' y 'algas' en la ración están en gramos o kilogramos.</small>
                </div>

                <!-- CANTIDAD DE ANIMALES -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Número de animales</label>
                    <input type="number" class="form-control" name="cantidad" min="1" required>
                </div>

                <!-- PERIODO -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Periodo de proyección</label>
                    <div class="input-group">
                        <input type="number" class="form-control" name="periodo" min="1" required>
                        <select class="form-select" name="unidad_periodo">
                            <option value="dias">Días</option>
                            <option value="semanas">Semanas</option>
                            <option value="meses">Meses</option>
                        </select>
                    </div>
                </div>

                <!-- BOTON -->
                <button type="submit" class="btn btn-ecoracion w-100">Generar proyección</button>
            </form>
        </div>

        <!-- RESULTADOS -->
        <div class="card shadow-sm p-4" id="resultados" style="display:none;">
            <h5 class="mb-3">Resultados de la proyección</h5>

            <p class="mb-1">Granos requeridos: <strong id="res-granos"></strong></p>
            <p class="mb-1">Algas requeridas: <strong id="res-algas"></strong></p>
            <p class="mb-1">Carbonato requerido: <strong id="res-carbonato"></strong></p>

            <hr>

            <p class="mb-1">Consumo optimizado (15% menos):  
                <strong class="result-highlight-green" id="res-optimizado"></strong>
            </p>

            <p class="mb-0">Ahorro total estimado:  
                <strong class="result-highlight-green" id="res-ahorro"></strong>
            </p>
        </div>

    </div>

    <!-- EXPORTACIONES + GRAFICO -->
    <div class="col-lg-5 d-flex flex-column gap-3">

        <!-- GRÁFICO (placeholder) -->
        <div class="card shadow-sm p-4 text-center">
            <h6 class="mb-2">Distribución de insumos</h6>
            <canvas id="proyeccionChart" style="max-height:250px;"></canvas>
        </div>

        <!-- BOTONES DE EXPORTACIÓN -->
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-secondary flex-fill">Exportar PDF</button>
            <button type="button" class="btn btn-ecoracion flex-fill">Exportar Excel</button>
        </div>

    </div>
</div>

<!-- SCRIPT DINÁMICO: calcula proyección usando datos de la ración seleccionada y dibuja gráfico -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const racionesData = {{ raciones_data_json|default:'{}'|safe }};
let chart = null;

function convertirPeriodoADias(periodo, unidad){
    if(unidad === 'semanas') return periodo * 7;
    if(unidad === 'meses') return periodo * 30;
    return periodo;
}

function renderChart(granos, algas, carbonato){
    const ctx = document.getElementById('proyeccionChart');
    const data = [granos, algas, carbonato];
    if(chart) chart.destroy();
    chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Granos (kg)', 'Algas (kg)', 'Carbonato (kg)'],
            datasets: [{
                data: data,
                backgroundColor: ['#0d8b3c', '#0f766e', '#f59e0b']
            }]
        },
        options: { responsive: true }
    });
}

document.getElementById('form-proyecciones').addEventListener('submit', function(e){
    e.preventDefault();
    const racionId = document.querySelector('[name="racion_id"]').value;
    const cantidad = parseFloat(document.querySelector('[name="cantidad"]').value) || 0;
    let periodo = parseFloat(document.querySelector('[name="periodo"]').value) || 0;
    const unidad = document.querySelector('[name="unidad_periodo"]').value;

    periodo = convertirPeriodoADias(periodo, unidad);

    // Obtener datos de la ración seleccionada
    const racion = racionesData[racionId];
    if(!racion){
        alert('Selecciona una ración válida');
        return;
    }

    // Interpretación: racion.granos y racion.algas pueden estar en gramos o kilogramos.
    // El usuario selecciona la unidad en el campo "unidad_racion".
    let granos_diarios = parseFloat(racion.granos) || 0; // en unidad según unidad_racion
    let algas_diarias = parseFloat(racion.algas) || 0;
    // Estimamos carbonato como 5% del total si no existe
    let carbonato_diario = ((granos_diarios + algas_diarias) * 0.05) || 0;

    const unidadRacion = document.getElementById('unidad_racion').value;
    let total_granos = 0, total_algas = 0, total_carbonato = 0;

    if (unidadRacion === 'g') {
        // valores en gramos → convertir a kg dividiendo por 1000
        total_granos = (granos_diarios * cantidad * periodo) / 1000;
        total_algas = (algas_diarias * cantidad * periodo) / 1000;
        total_carbonato = (carbonato_diario * cantidad * periodo) / 1000;
    } else {
        // valores ya en kilogramos
        total_granos = (granos_diarios * cantidad * periodo);
        total_algas = (algas_diarias * cantidad * periodo);
        total_carbonato = (carbonato_diario * cantidad * periodo);
    }

    const consumo_total = total_granos + total_algas + total_carbonato;
    const consumo_opt = consumo_total * 0.85;
    const ahorro = consumo_total - consumo_opt;

    document.getElementById('res-granos').innerText = total_granos.toFixed(2) + ' kg';
    document.getElementById('res-algas').innerText = total_algas.toFixed(2) + ' kg';
    document.getElementById('res-carbonato').innerText = total_carbonato.toFixed(2) + ' kg';
    document.getElementById('res-optimizado').innerText = consumo_opt.toFixed(2) + ' kg';
    document.getElementById('res-ahorro').innerText = ahorro.toFixed(2) + ' kg';
    document.getElementById('resultados').style.display = 'block';

    // Render chart
    renderChart(total_granos, total_algas, total_carbonato);
});
</script>

{% endblock %}
